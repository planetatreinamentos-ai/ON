<?php
/**
 * Google Drive Service
 * 
 * Serviço para upload de certificados no Google Drive
 * 
 * @package PlanetaTreinamentos\Services
 * @since 1.0
 */

namespace PlanetaTreinamentos\Services;

use Google\Client;
use Google\Service\Drive;
use Google\Service\Drive\DriveFile;
use PlanetaTreinamentos\Helpers\Logger;
use Exception;

class GoogleDriveService
{
    /**
     * Google Client
     */
    private ?Client $client = null;
    
    /**
     * Drive Service
     */
    private ?Drive $driveService = null;
    
    /**
     * Configurações
     */
    private array $config;
    
    /**
     * Construtor
     */
    public function __construct()
    {
        $this->config = require __DIR__ . '/../../config/app.php';
        
        if ($this->config['gdrive']['enabled']) {
            $this->initialize();
        }
    }
    
    /**
     * Inicializa Google Client
     */
    private function initialize(): void
    {
        try {
            if (!class_exists('Google\Client')) {
                Logger::warning('Google API Client não está instalado');
                return;
            }
            
            $this->client = new Client();
            $this->client->setApplicationName($this->config['company']['name']);
            $this->client->setScopes([Drive::DRIVE_FILE]);
            $this->client->setAuthConfig([
                'client_id' => $this->config['gdrive']['client_id'],
                'client_secret' => $this->config['gdrive']['client_secret'],
                'refresh_token' => $this->config['gdrive']['refresh_token']
            ]);
            $this->client->setAccessType('offline');
            
            $this->driveService = new Drive($this->client);
            
        } catch (Exception $e) {
            Logger::error('Erro ao inicializar Google Drive: ' . $e->getMessage());
            $this->client = null;
            $this->driveService = null;
        }
    }
    
    /**
     * Verifica se o serviço está disponível
     */
    public function isAvailable(): bool
    {
        return $this->driveService !== null;
    }
    
    /**
     * Faz upload de certificado
     * 
     * @param string $filePath Caminho do arquivo local
     * @param array $aluno Dados do aluno
     * @return string|null ID do arquivo no Drive ou URL pública
     */
    public function uploadCertificate(string $filePath, array $aluno): ?string
    {
        if (!$this->isAvailable()) {
            Logger::warning('Google Drive não está disponível');
            return null;
        }
        
        try {
            // Cria pasta do curso se não existir
            $courseFolderId = $this->getOrCreateCourseFolder($aluno['curso_nome']);
            
            // Metadata do arquivo
            $fileMetadata = new DriveFile([
                'name' => basename($filePath),
                'parents' => [$courseFolderId],
                'description' => "Certificado de {$aluno['nome']} - ID: {$aluno['alunoid']}"
            ]);
            
            // Upload
            $content = file_get_contents($filePath);
            $file = $this->driveService->files->create($fileMetadata, [
                'data' => $content,
                'mimeType' => 'image/jpeg',
                'uploadType' => 'multipart',
                'fields' => 'id,webViewLink,webContentLink'
            ]);
            
            // Torna o arquivo público (somente leitura)
            $this->makeFilePublic($file->id);
            
            Logger::info('Certificado enviado para Google Drive', [
                'aluno_id' => $aluno['id'],
                'file_id' => $file->id,
                'file_name' => basename($filePath)
            ]);
            
            // Retorna URL de visualização
            return $file->webViewLink ?? $file->webContentLink;
            
        } catch (Exception $e) {
            Logger::error('Erro ao fazer upload para Google Drive: ' . $e->getMessage(), [
                'aluno_id' => $aluno['id'] ?? null
            ]);
            return null;
        }
    }
    
    /**
     * Obtém ou cria pasta do curso
     */
    private function getOrCreateCourseFolder(string $courseName): string
    {
        $rootFolderId = $this->config['gdrive']['folder_id'];
        
        try {
            // Busca pasta existente
            $response = $this->driveService->files->listFiles([
                'q' => "name='$courseName' and mimeType='application/vnd.google-apps.folder' and '$rootFolderId' in parents and trashed=false",
                'fields' => 'files(id, name)'
            ]);
            
            if (count($response->files) > 0) {
                return $response->files[0]->id;
            }
            
            // Cria nova pasta
            $folderMetadata = new DriveFile([
                'name' => $courseName,
                'mimeType' => 'application/vnd.google-apps.folder',
                'parents' => [$rootFolderId]
            ]);
            
            $folder = $this->driveService->files->create($folderMetadata, [
                'fields' => 'id'
            ]);
            
            return $folder->id;
            
        } catch (Exception $e) {
            Logger::error('Erro ao criar pasta no Drive: ' . $e->getMessage());
            return $rootFolderId;
        }
    }
    
    /**
     * Torna arquivo público
     */
    private function makeFilePublic(string $fileId): void
    {
        try {
            $permission = new \Google\Service\Drive\Permission([
                'type' => 'anyone',
                'role' => 'reader'
            ]);
            
            $this->driveService->permissions->create($fileId, $permission);
            
        } catch (Exception $e) {
            Logger::error('Erro ao tornar arquivo público: ' . $e->getMessage());
        }
    }
    
    /**
     * Remove arquivo do Drive
     */
    public function deleteFile(string $fileId): bool
    {
        if (!$this->isAvailable()) {
            return false;
        }
        
        try {
            $this->driveService->files->delete($fileId);
            return true;
        } catch (Exception $e) {
            Logger::error('Erro ao deletar arquivo do Drive: ' . $e->getMessage());
            return false;
        }
    }
}
