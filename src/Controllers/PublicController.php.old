<?php

namespace PlanetaTreinamentos\Controllers;

use PlanetaTreinamentos\Models\Curso;
use PlanetaTreinamentos\Models\Professor;
use PlanetaTreinamentos\Models\Aluno;
use PlanetaTreinamentos\Models\Interessado;
use PlanetaTreinamentos\Helpers\EmailHelper;

/**
 * Controller para páginas públicas (homepage, sobre, etc)
 */
class PublicController extends Controller
{
    private Curso $cursoModel;
    private Professor $professorModel;
    private Aluno $alunoModel;
    private Interessado $interessadoModel;
    private EmailHelper $emailHelper;

    public function __construct()
    {
        parent::__construct();
        $this->cursoModel = new Curso($this->db);
        $this->professorModel = new Professor($this->db);
        $this->alunoModel = new Aluno($this->db);
        $this->interessadoModel = new Interessado($this->db);
        $this->emailHelper = new EmailHelper();
    }

    /**
     * Homepage
     * URL: /
     */
    public function home(): void
    {
        // Buscar cursos ativos
        $cursos = $this->cursoModel->getAll(['status' => 'ativo']);
        
        // Adicionar contagem de alunos por curso
        foreach ($cursos as &$curso) {
            $curso['total_alunos'] = $this->alunoModel->countByCurso($curso['id']);
        }

        // Buscar professores ativos
        $professores = $this->professorModel->getAll(['status' => 'ativo']);
        
        // Adicionar contagem de alunos por professor
        foreach ($professores as &$professor) {
            $alunos = $this->alunoModel->getByProfessor($professor['id']);
            $professor['total_alunos'] = count($alunos);
        }

        // Buscar alunos de destaque (com melhor nota ou marcados como melhor aluno)
        $alunosDestaque = $this->alunoModel->getDestaque(12); // Top 12

        // Estatísticas
        $estatisticas = [
            'total_alunos' => $this->alunoModel->count(),
            'total_turmas' => $this->alunoModel->countTurmas(),
            'total_professores' => $this->professorModel->count(['status' => 'ativo']),
            'anos_experiencia' => $this->calcularAnosExperiencia(),
            'nota_media' => $this->alunoModel->getMediaNotas()
        ];

        // Configurações
        $config = $this->getConfig();

        // Dados para a view
        $data = [
            'pageTitle' => ($config['nome_empresa'] ?? 'Planeta Treinamentos') . ' - Cursos Profissionalizantes',
            'metaDescription' => $config['descricao_empresa'] ?? 'Formando profissionais qualificados',
            'metaKeywords' => 'cursos, treinamento, smartphone, certificado, ' . ($config['nome_empresa'] ?? ''),
            'cursos' => $cursos,
            'professores' => $professores,
            'alunosDestaque' => $alunosDestaque,
            'estatisticas' => $estatisticas,
            'config' => $config
        ];

        // Renderizar homepage
        $this->render('public/home', $data, 'public');
    }

    /**
     * Página Sobre
     * URL: /sobre
     */
    public function sobre(): void
    {
        // Estatísticas
        $estatisticas = [
            'total_alunos' => $this->alunoModel->count(),
            'total_turmas' => $this->alunoModel->countTurmas(),
            'total_professores' => $this->professorModel->count(['status' => 'ativo']),
            'nota_media' => $this->alunoModel->getMediaNotas()
        ];

        // Configurações
        $config = $this->getConfig();

        // Dados para a view
        $data = [
            'pageTitle' => 'Sobre Nós | ' . ($config['nome_empresa'] ?? 'Planeta Treinamentos'),
            'metaDescription' => 'Conheça a história e os valores da ' . ($config['nome_empresa'] ?? 'nossa empresa'),
            'estatisticas' => $estatisticas,
            'config' => $config
        ];

        // Renderizar página sobre
        $this->render('public/sobre', $data, 'public');
    }

    /**
     * Criar interessado (formulário da homepage)
     * POST /interessados/criar
     */
    public function createInteressado(): void
    {
        // Verificar CSRF
        if (!$this->validateCSRF()) {
            $_SESSION['error'] = 'Token inválido. Tente novamente.';
            $this->redirect('/#interesse');
            return;
        }

        // Validar dados
        $nome = filter_input(INPUT_POST, 'nome', FILTER_SANITIZE_STRING);
        $email = filter_input(INPUT_POST, 'email', FILTER_SANITIZE_EMAIL);
        $whatsapp = filter_input(INPUT_POST, 'whatsapp', FILTER_SANITIZE_STRING);
        $curso_interesse = filter_input(INPUT_POST, 'curso_interesse', FILTER_SANITIZE_NUMBER_INT);
        $mensagem = filter_input(INPUT_POST, 'mensagem', FILTER_SANITIZE_STRING);

        // Proteção anti-spam (Honeypot)
        if (!empty($_POST['website'])) {
            $this->log('Tentativa de spam detectada no formulário de interesse', 'warning');
            $_SESSION['success'] = 'Interesse enviado com sucesso!';
            $this->redirect('/#interesse');
            return;
        }

        // Validações
        if (empty($nome) || empty($email)) {
            $_SESSION['error'] = 'Nome e email são obrigatórios.';
            $_SESSION['old'] = $_POST;
            $this->redirect('/#interesse');
            return;
        }

        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $_SESSION['error'] = 'Email inválido.';
            $_SESSION['old'] = $_POST;
            $this->redirect('/#interesse');
            return;
        }

        // Rate limiting
        if (!$this->checkRateLimit('interessados', 3, 3600)) {
            $_SESSION['error'] = 'Você atingiu o limite de envios. Tente novamente mais tarde.';
            $this->redirect('/#interesse');
            return;
        }

        // Verificar se email já existe (últimos 30 dias)
        if ($this->interessadoModel->emailExists($email)) {
            $_SESSION['error'] = 'Este email já foi cadastrado recentemente. Entraremos em contato em breve.';
            $this->redirect('/#interesse');
            return;
        }

        // Criar interessado
        $data = [
            'nome' => $nome,
            'email' => $email,
            'whatsapp' => $whatsapp,
            'curso_interesse' => $curso_interesse ?: null,
            'mensagem' => $mensagem,
            'origem' => 'homepage'
        ];

        if ($this->interessadoModel->create($data)) {
            // Enviar email para o admin
            $this->notifyAdminNewInterest($data);

            // Log
            $this->log('Novo interessado cadastrado', 'info', [
                'nome' => $nome,
                'email' => $email
            ]);

            $_SESSION['success'] = 'Interesse enviado com sucesso! Entraremos em contato em breve.';
        } else {
            $_SESSION['error'] = 'Erro ao processar sua solicitação. Tente novamente.';
        }

        $this->redirect('/#interesse');
    }

    /**
     * Página de erro genérica
     * URL: /erro
     */
    public function error(): void
    {
        $mensagem = $_GET['msg'] ?? 'Página não encontrada';
        
        $config = $this->getConfig();

        $data = [
            'pageTitle' => 'Erro | ' . ($config['nome_empresa'] ?? 'Planeta Treinamentos'),
            'mensagem' => $mensagem,
            'config' => $config
        ];

        http_response_code(404);
        $this->render('public/error', $data, 'public');
    }

    /**
     * Notificar admin sobre novo interessado
     */
    private function notifyAdminNewInterest(array $data): void
    {
        try {
            $config = $this->getConfig();
            
            $cursoNome = 'Não especificado';
            if (!empty($data['curso_interesse'])) {
                $curso = $this->cursoModel->getById($data['curso_interesse']);
                $cursoNome = $curso['nome'] ?? 'Não especificado';
            }

            $emailBody = "
            <h2>Novo Interessado Cadastrado!</h2>
            <p>Um novo interessado preencheu o formulário na homepage.</p>
            
            <h3>Dados do Interessado:</h3>
            <p><strong>Nome:</strong> {$data['nome']}</p>
            <p><strong>Email:</strong> {$data['email']}</p>
            <p><strong>WhatsApp:</strong> " . ($data['whatsapp'] ?: 'Não informado') . "</p>
            <p><strong>Curso de Interesse:</strong> {$cursoNome}</p>
            
            " . (!empty($data['mensagem']) ? "<p><strong>Mensagem:</strong><br>" . nl2br($data['mensagem']) . "</p>" : "") . "
            
            <hr>
            <p><small>Cadastrado em: " . date('d/m/Y H:i:s') . "</small></p>
            <p><small>IP: " . ($_SERVER['REMOTE_ADDR'] ?? 'unknown') . "</small></p>
            
            <p><a href='" . $config['site_url'] . "/admin/interessados' class='btn btn-primary'>Visualizar no Painel Admin</a></p>
            ";

            $this->emailHelper->send(
                $config['email_admin'],
                $config['nome_empresa'],
                "Novo Interessado: " . $data['nome'],
                $emailBody
            );
        } catch (\Exception $e) {
            error_log("Erro ao enviar email de notificação: " . $e->getMessage());
        }
    }

    /**
     * Calcular anos de experiência baseado na data de fundação
     */
    private function calcularAnosExperiencia(): int
    {
        $config = $this->getConfig();
        
        if (!empty($config['data_fundacao'])) {
            $dataFundacao = new \DateTime($config['data_fundacao']);
            $hoje = new \DateTime();
            $anos = $hoje->diff($dataFundacao)->y;
            return $anos > 0 ? $anos : 1;
        }
        
        // Calcular pela data do aluno mais antigo
        try {
            $stmt = $this->db->query("SELECT MIN(data_inicio) as primeira_turma FROM alunos WHERE deleted_at IS NULL");
            $result = $stmt->fetch(\PDO::FETCH_ASSOC);
            
            if (!empty($result['primeira_turma'])) {
                $primeiraTurma = new \DateTime($result['primeira_turma']);
                $hoje = new \DateTime();
                $anos = $hoje->diff($primeiraTurma)->y;
                return $anos > 0 ? $anos : 1;
            }
        } catch (\Exception $e) {
            error_log("Erro ao calcular anos de experiência: " . $e->getMessage());
        }
        
        return 5; // Padrão
    }
}