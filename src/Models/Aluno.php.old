<?php
/**
 * Model Aluno
 * 
 * Gerencia operações com alunos
 * 
 * @package PlanetaTreinamentos\Models
 * @since 1.0
 */

namespace PlanetaTreinamentos\Models;

use PlanetaTreinamentos\Core\Database;

class Aluno
{
    private Database $db;
    
    public function __construct()
    {
        $this->db = Database::getInstance();
    }
    
    /**
     * Lista todos os alunos (com joins)
     */
    public function all(): array
    {
        $sql = "SELECT 
                    a.*,
                    c.nome as curso_nome,
                    p.nome as professor_nome,
                    ch.horas as carga_horaria
                FROM alunos a
                LEFT JOIN cursos c ON a.curso_id = c.id
                LEFT JOIN professores p ON a.professor_id = p.id
                LEFT JOIN cargas_horarias ch ON a.carga_horaria_id = ch.id
                WHERE a.deleted_at IS NULL
                ORDER BY a.created_at DESC";
        return $this->db->fetchAll($sql);
    }
    
    /**
     * Busca aluno por ID
     */
    public function findById(int $id): ?array
    {
        $sql = "SELECT 
                    a.*,
                    c.nome as curso_nome,
                    c.frase_certificado,
                    p.nome as professor_nome,
                    p.assinatura as professor_assinatura,
                    ch.horas as carga_horaria
                FROM alunos a
                LEFT JOIN cursos c ON a.curso_id = c.id
                LEFT JOIN professores p ON a.professor_id = p.id
                LEFT JOIN cargas_horarias ch ON a.carga_horaria_id = ch.id
                WHERE a.id = :id AND a.deleted_at IS NULL";
        return $this->db->fetchOne($sql, ['id' => $id]);
    }
    
    /**
     * Busca aluno por alunoId (slug)
     */
    public function findByAlunoId(string $alunoid): ?array
    {
        $sql = "SELECT 
                    a.*,
                    c.nome as curso_nome,
                    c.frase_certificado,
                    p.nome as professor_nome,
                    p.assinatura as professor_assinatura,
                    ch.horas as carga_horaria
                FROM alunos a
                LEFT JOIN cursos c ON a.curso_id = c.id
                LEFT JOIN professores p ON a.professor_id = p.id
                LEFT JOIN cargas_horarias ch ON a.carga_horaria_id = ch.id
                WHERE a.alunoid = :alunoid AND a.deleted_at IS NULL";
        return $this->db->fetchOne($sql, ['alunoid' => $alunoid]);
    }
    
    /**
     * Verifica se alunoId já existe
     */
    public function alunoIdExists(string $alunoid, ?int $exceptId = null): bool
    {
        $sql = "SELECT COUNT(*) FROM alunos WHERE alunoid = :alunoid AND deleted_at IS NULL";
        $params = ['alunoid' => $alunoid];
        
        if ($exceptId) {
            $sql .= " AND id != :id";
            $params['id'] = $exceptId;
        }
        
        return (int) $this->db->fetchColumn($sql, $params) > 0;
    }
    
    /**
     * Gera alunoId único
     */
    public function generateUniqueAlunoId(): string
    {
        do {
            $alunoid = strtoupper(bin2hex(random_bytes(4)));
        } while ($this->alunoIdExists($alunoid));
        
        return $alunoid;
    }
    
    /**
     * Cria novo aluno
     */
    public function create(array $data): int
    {
        $data['created_at'] = date('Y-m-d H:i:s');
        return $this->db->insert('alunos', $data);
    }
    
    /**
     * Atualiza aluno
     */
    public function update(int $id, array $data): bool
    {
        $data['updated_at'] = date('Y-m-d H:i:s');
        return $this->db->update('alunos', $data, 'id = :id', [':id' => $id]) > 0;
    }
    
    /**
     * Soft delete
     */
    public function delete(int $id): bool
    {
        return $this->db->update('alunos', [
            'deleted_at' => date('Y-m-d H:i:s')
        ], 'id = :id', [':id' => $id]) > 0;
    }
    
    /**
     * Restaura aluno deletado
     */
    public function restore(int $id): bool
    {
        return $this->db->update('alunos', [
            'deleted_at' => null
        ], 'id = :id', [':id' => $id]) > 0;
    }
    
    /**
     * Conta total de alunos
     */
    public function count(): int
    {
        $sql = "SELECT COUNT(*) FROM alunos WHERE deleted_at IS NULL";
        return (int) $this->db->fetchColumn($sql);
    }
    
    /**
     * Busca melhor aluno por curso
     */
    public function getMelhorAlunoByCurso(int $cursoId): ?array
    {
        $sql = "SELECT a.* 
                FROM alunos a
                WHERE a.curso_id = :curso_id 
                AND a.melhor_aluno = 1 
                AND a.deleted_at IS NULL
                LIMIT 1";
        return $this->db->fetchOne($sql, ['curso_id' => $cursoId]);
    }
    
    /**
     * Define melhor aluno (remove dos outros do mesmo curso)
     */
    public function setMelhorAluno(int $id, int $cursoId): bool
    {
        $this->db->beginTransaction();
        
        try {
            // Remove flag de todos os alunos do curso
            $this->db->query(
                "UPDATE alunos SET melhor_aluno = 0 WHERE curso_id = :curso_id",
                ['curso_id' => $cursoId]
            );
            
            // Define novo melhor aluno
            $this->db->update('alunos', ['melhor_aluno' => 1], 'id = :id', [':id' => $id]);
            
            $this->db->commit();
            return true;
        } catch (\Exception $e) {
            $this->db->rollback();
            return false;
        }
    }
    
    /**
     * Marca certificado como emitido
     */
    public function marcarCertificadoEmitido(int $id, string $certificadoUrl): bool
    {
        return $this->db->update('alunos', [
            'certificado_emitido' => 1,
            'certificado_url' => $certificadoUrl,
            'certificado_emitido_em' => date('Y-m-d H:i:s')
        ], 'id = :id', [':id' => $id]) > 0;
    }
}
