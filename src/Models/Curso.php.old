<?php
/**
 * Model Curso
 * 
 * Gerencia operações com cursos
 * 
 * @package PlanetaTreinamentos\Models
 * @since 1.0
 */

namespace PlanetaTreinamentos\Models;

use PlanetaTreinamentos\Core\Database;

class Curso
{
    private Database $db;
    
    public function __construct()
    {
        $this->db = Database::getInstance();
    }
    
    /**
     * Lista todos os cursos ativos
     */
    public function all(): array
    {
        $sql = "SELECT * FROM cursos WHERE status = 1 ORDER BY ordem_exibicao, nome";
        return $this->db->fetchAll($sql);
    }
    
    /**
     * Lista todos incluindo inativos
     */
    public function allWithInactive(): array
    {
        $sql = "SELECT * FROM cursos ORDER BY ordem_exibicao, nome";
        return $this->db->fetchAll($sql);
    }
    
    /**
     * Busca curso por ID
     */
    public function findById(int $id): ?array
    {
        $sql = "SELECT * FROM cursos WHERE id = :id";
        return $this->db->fetchOne($sql, ['id' => $id]);
    }
    
    /**
     * Cria novo curso
     */
    public function create(array $data): int
    {
        $data['created_at'] = date('Y-m-d H:i:s');
        return $this->db->insert('cursos', $data);
    }
    
    /**
     * Atualiza curso
     */
    public function update(int $id, array $data): bool
    {
        $data['updated_at'] = date('Y-m-d H:i:s');
        return $this->db->update('cursos', $data, 'id = :id', [':id' => $id]) > 0;
    }
    
    /**
     * Deleta curso
     */
    public function delete(int $id): bool
    {
        return $this->db->delete('cursos', 'id = :id', [':id' => $id]) > 0;
    }
    
    /**
     * Conta total de cursos
     */
    public function count(): int
    {
        $sql = "SELECT COUNT(*) FROM cursos WHERE status = 1";
        return (int) $this->db->fetchColumn($sql);
    }
    
    /**
     * Verifica se curso tem alunos
     */
    public function hasAlunos(int $id): bool
    {
        $sql = "SELECT COUNT(*) FROM alunos WHERE curso_id = :id AND deleted_at IS NULL";
        return (int) $this->db->fetchColumn($sql, ['id' => $id]) > 0;
    }
}
