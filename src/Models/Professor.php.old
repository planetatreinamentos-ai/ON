<?php
/**
 * Model Professor
 * 
 * Gerencia operações com professores
 * 
 * @package PlanetaTreinamentos\Models
 * @since 1.0
 */

namespace PlanetaTreinamentos\Models;

use PlanetaTreinamentos\Core\Database;

class Professor
{
    private Database $db;
    
    public function __construct()
    {
        $this->db = Database::getInstance();
    }
    
    /**
     * Lista todos os professores ativos
     */
    public function all(): array
    {
        $sql = "SELECT * FROM professores WHERE status = 1 ORDER BY ordem_exibicao, nome";
        return $this->db->fetchAll($sql);
    }
    
    /**
     * Lista todos incluindo inativos
     */
    public function allWithInactive(): array
    {
        $sql = "SELECT * FROM professores ORDER BY ordem_exibicao, nome";
        return $this->db->fetchAll($sql);
    }
    
    /**
     * Busca professor por ID
     */
    public function findById(int $id): ?array
    {
        $sql = "SELECT * FROM professores WHERE id = :id";
        return $this->db->fetchOne($sql, ['id' => $id]);
    }
    
    /**
     * Busca professor por professorId (slug)
     */
    public function findByProfessorId(string $professorid): ?array
    {
        $sql = "SELECT * FROM professores WHERE professorid = :professorid AND status = 1";
        return $this->db->fetchOne($sql, ['professorid' => $professorid]);
    }
    
    /**
     * Verifica se professorId já existe
     */
    public function professorIdExists(string $professorid, ?int $exceptId = null): bool
    {
        $sql = "SELECT COUNT(*) FROM professores WHERE professorid = :professorid";
        $params = ['professorid' => $professorid];
        
        if ($exceptId) {
            $sql .= " AND id != :id";
            $params['id'] = $exceptId;
        }
        
        return (int) $this->db->fetchColumn($sql, $params) > 0;
    }
    
    /**
     * Cria novo professor
     */
    public function create(array $data): int
    {
        $data['created_at'] = date('Y-m-d H:i:s');
        return $this->db->insert('professores', $data);
    }
    
    /**
     * Atualiza professor
     */
    public function update(int $id, array $data): bool
    {
        $data['updated_at'] = date('Y-m-d H:i:s');
        return $this->db->update('professores', $data, 'id = :id', [':id' => $id]) > 0;
    }
    
    /**
     * Deleta professor
     */
    public function delete(int $id): bool
    {
        return $this->db->delete('professores', 'id = :id', [':id' => $id]) > 0;
    }
    
    /**
     * Conta total de professores
     */
    public function count(): int
    {
        $sql = "SELECT COUNT(*) FROM professores WHERE status = 1";
        return (int) $this->db->fetchColumn($sql);
    }
    
    /**
     * Verifica se professor tem alunos
     */
    public function hasAlunos(int $id): bool
    {
        $sql = "SELECT COUNT(*) FROM alunos WHERE professor_id = :id AND deleted_at IS NULL";
        return (int) $this->db->fetchColumn($sql, ['id' => $id]) > 0;
    }
    
    /**
     * Busca certificados do professor
     */
    public function getCertificados(int $id): array
    {
        $sql = "SELECT * FROM professores_certificados 
                WHERE professor_id = :id 
                ORDER BY ordem, ano DESC";
        return $this->db->fetchAll($sql, ['id' => $id]);
    }
    
    /**
     * Adiciona certificado ao professor
     */
    public function addCertificado(int $professorId, array $data): int
    {
        $data['professor_id'] = $professorId;
        $data['created_at'] = date('Y-m-d H:i:s');
        return $this->db->insert('professores_certificados', $data);
    }
    
    /**
     * Remove certificado do professor
     */
    public function removeCertificado(int $id): bool
    {
        return $this->db->delete('professores_certificados', 'id = :id', [':id' => $id]) > 0;
    }
}
