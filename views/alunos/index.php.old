<?php
/**
 * View: Lista de Alunos
 * 
 * @var array $alunos Lista de alunos
 */
?>

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><?= $pageTitle ?? 'Alunos' ?></h1>
        <a href="/admin/alunos/create" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Novo Aluno
        </a>
    </div>

    <?php if (empty($alunos)): ?>
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Nenhum aluno cadastrado ainda.
        </div>
    <?php else: ?>
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="alunosTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">Foto</th>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Curso</th>
                                <th>Professor</th>
                                <th>Início</th>
                                <th>Conclusão</th>
                                <th>Status</th>
                                <th style="width: 150px;" class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($alunos as $aluno): ?>
                                <tr>
                                    <td>
                                        <?php if (!empty($aluno['foto'])): ?>
                                            <img src="/uploads/<?= htmlspecialchars($aluno['foto']) ?>" 
                                                 alt="<?= htmlspecialchars($aluno['nome']) ?>"
                                                 class="rounded-circle"
                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                        <?php else: ?>
                                            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary"><?= htmlspecialchars($aluno['alunoid'] ?? '-') ?></span>
                                    </td>
                                    <td>
                                        <strong><?= htmlspecialchars($aluno['nome']) ?></strong>
                                        <?php if (!empty($aluno['melhor_aluno'])): ?>
                                            <i class="fas fa-star text-warning ms-1" title="Melhor Aluno"></i>
                                        <?php endif; ?>
                                    </td>
                                    <td><?= htmlspecialchars($aluno['email']) ?></td>
                                    <td><?= htmlspecialchars($aluno['curso_nome'] ?? '-') ?></td>
                                    <td><?= htmlspecialchars($aluno['professor_nome'] ?? '-') ?></td>
                                    <td><?= date('d/m/Y', strtotime($aluno['data_inicio'])) ?></td>
                                    <td><?= date('d/m/Y', strtotime($aluno['data_conclusao'])) ?></td>
                                    <td>
                                        <?php if (!empty($aluno['certificado_emitido'])): ?>
                                            <span class="badge bg-success">
                                                <i class="fas fa-certificate me-1"></i>Certificado
                                            </span>
                                        <?php else: ?>
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>Em andamento
                                            </span>
                                        <?php endif; ?>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="/admin/alunos/edit/<?= $aluno['id'] ?>" 
                                               class="btn btn-sm btn-outline-primary"
                                               title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger btn-delete"
                                                    data-id="<?= $aluno['id'] ?>"
                                                    data-nome="<?= htmlspecialchars($aluno['nome']) ?>"
                                                    title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    <?php endif; ?>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DataTable
    if (document.getElementById('alunosTable')) {
        $('#alunosTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
            },
            order: [[2, 'asc']],
            pageLength: 25
        });
    }

    // Delete
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            const nome = this.dataset.nome;
            
            if (!confirm(`Tem certeza que deseja excluir o aluno "${nome}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/alunos/delete/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.location.reload();
                } else {
                    alert(result.message || 'Erro ao excluir aluno.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir aluno.');
            }
        });
    });
});
</script>