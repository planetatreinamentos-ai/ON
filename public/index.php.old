<?php
/**
 * Planeta Treinamentos - Entry Point
 * Este é o ponto de entrada da aplicação
 */

// Definir que estamos no ambiente público
define('PUBLIC_PATH', __DIR__);
define('ROOT_PATH', dirname(__DIR__));

// Mostrar erros em desenvolvimento (desabilitar em produção)
if (file_exists(ROOT_PATH . '/.env')) {
    $envContent = file_get_contents(ROOT_PATH . '/.env');
    if (strpos($envContent, 'APP_DEBUG=true') !== false) {
        error_reporting(E_ALL);
        ini_set('display_errors', 1);
    }
}

// Carregar autoload do Composer
if (file_exists(ROOT_PATH . '/vendor/autoload.php')) {
    require_once ROOT_PATH . '/vendor/autoload.php';
} else {
    die('Erro: Execute "composer install" primeiro!');
}

// Carregar helpers globais
if (file_exists(ROOT_PATH . '/src/Helpers/helpers.php')) {
    require_once ROOT_PATH . '/src/Helpers/helpers.php';
}

// Carregar variáveis de ambiente
try {
    if (file_exists(ROOT_PATH . '/.env')) {
        $dotenv = Dotenv\Dotenv::createImmutable(ROOT_PATH);
        $dotenv->load();
    }
} catch (Exception $e) {
    die('Erro ao carregar .env: ' . $e->getMessage());
}

// Iniciar sessão
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// Carregar e executar aplicação
try {
    // Verificar se classe App existe
    if (!class_exists('PlanetaTreinamentos\Core\App')) {
        die('Erro: Classe App não encontrada. Verifique se todos os arquivos foram enviados.');
    }
    
    $app = new PlanetaTreinamentos\Core\App();
    $app->run();
    
} catch (Exception $e) {
    // Log do erro
    $logFile = ROOT_PATH . '/storage/logs/app.log';
    $logDir = dirname($logFile);
    
    if (!is_dir($logDir)) {
        @mkdir($logDir, 0755, true);
    }
    
    $timestamp = date('Y-m-d H:i:s');
    $errorLog = "[$timestamp] [CRITICAL] Fatal error in index.php: " . $e->getMessage() . "\n";
    $errorLog .= "File: " . $e->getFile() . "\n";
    $errorLog .= "Line: " . $e->getLine() . "\n";
    $errorLog .= "Trace: " . $e->getTraceAsString() . "\n\n";
    
    @file_put_contents($logFile, $errorLog, FILE_APPEND);
    
    // Mostrar erro amigável
    if (isset($_ENV['APP_DEBUG']) && $_ENV['APP_DEBUG'] === 'true') {
        echo '<h1>Erro Fatal</h1>';
        echo '<pre>' . htmlspecialchars($e->getMessage()) . '</pre>';
        echo '<pre>' . htmlspecialchars($e->getTraceAsString()) . '</pre>';
    } else {
        // Página de erro em produção
        http_response_code(500);
        if (file_exists(ROOT_PATH . '/views/errors/500.php')) {
            include ROOT_PATH . '/views/errors/500.php';
        } else {
            echo '<h1>Erro no servidor</h1><p>Por favor, tente novamente mais tarde.</p>';
        }
    }
}